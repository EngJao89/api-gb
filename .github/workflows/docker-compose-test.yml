name: Docker Compose Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  docker-compose-test:
    name: Test with Docker Compose
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        echo "POSTGRES_USER=admin" >> .env
        echo "POSTGRES_PASSWORD=GoBarber123" >> .env
        echo "POSTGRES_DB=nest_db" >> .env
        echo "DATABASE_URL=postgresql://admin:GoBarber123@postgres:5432/nest_db?schema=public" >> .env
        echo "JWT_SECRET=test-jwt-secret" >> .env
        echo "JWT_EXPIRES_IN=7d" >> .env

    - name: Build and test with Docker Compose
      run: |
        docker compose up --build -d
        sleep 30  # Wait for services to be ready
        
        # Test if the application is running
        curl -f http://localhost:3333 || exit 1
        
        # Test database connection
        docker compose exec -T app npx prisma db push --accept-data-loss
        
        # Run tests inside the container
        docker compose exec -T app npm run test
        
        # Cleanup
        docker compose down -v

    - name: Upload logs on failure
      if: failure()
      run: |
        docker compose logs > docker-logs.txt
        echo "Docker logs saved to docker-logs.txt"
